(()=>{"use strict";var e=function(e){var n=Math.pow(10,1<arguments.length&&void 0!==arguments[1]?arguments[1]:5);return-0!=(e=Math.round(e*n)/n)||0===e&&1/e!=-1/0?e:0};function n(e){return function(e){if(Array.isArray(e))return r(e)}(e)||function(){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}()||t(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function t(e,n){if(e){if("string"==typeof e)return r(e,n);var t=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(t="Object"===t&&e.constructor?e.constructor.name:t)||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?r(e,n):void 0}}function r(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,r=new Array(n);t<n;t++)r[t]=e[t];return r}function i(e){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function f(e){if("number"==typeof e||"boolean"==typeof e||"string"==typeof e||null==e||NaN===e||"function"==typeof e)return e;if("function"==typeof e._dup)return e._dup();if(Array.isArray(e)){var n=[];return e.forEach((function(e){return n.push(f(e))})),n}var t={};return Object.keys(e).forEach((function(n){var r=f(e[n]);t[n]=r})),t}function a(n,t,r,i){var f=1<arguments.length&&void 0!==t?t:"",o=2<arguments.length&&void 0!==r?r:{},s=3<arguments.length&&void 0!==i?i:null;return"string"==typeof n||"boolean"==typeof n||"function"==typeof n?o["".concat(f)]=n:"number"==typeof n?o["".concat(f)]=null!=s?e(n,s):n:null===n?o["".concat(f)]=null:void 0===n||(Array.isArray(n)?n.forEach((function(e,n){a(e,"".concat(f,"[").concat(n,"]"),o,s)})):Object.keys(n).forEach((function(e){a(n[e],"".concat(f,".").concat(e),o,s)}))),o}function o(e,n,t,r){var f=3<arguments.length&&void 0!==r&&r,a=e[0];if(0!==a.length)if(r=a.match(/\[[^\]]*\]/g),a=a.replace(/\[.*/,""),1!==e.length||!f||r){if(r){var s=r.map((function(e){return parseInt(e.replace(/\[|\]/g,""),10)}));null!=n[a]&&Array.isArray(n[a])||(n[a]=[]);for(var c=n[a],l=0,u=0;u<s.length;u+=1){if(l=s[u],c.length<=l)for(var d=c.length;d<l-c.length+1;d+=1)c.push(void 0);u<s.length-1&&(Array.isArray(c[l])||(c[l]=[]),c=c[l])}return 1===e.length&&f?void(c[l]=void 0):1===e.length?void(c[l]=t):(null!=c[l]&&"object"===i(c[l])||(c[l]={}),void o(e.slice(1),c[l],t,f))}1!==e.length?(null==n[a]&&(n[a]={}),o(e.slice(1),n[a],t,f)):n[a]=t}else delete n[a]}function s(e){var n={};return Object.keys(e).forEach((function(t){var r=t.split(".").filter((function(e){return 0<e.length}));t=e[t],Array.isArray(t)?o(r,n,t.slice(-1)[0]):o(r,n,t)})),n}function c(e){for(var n=f(e),t=function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];Object.keys(e).forEach((function(r){var i=r.split(".").filter((function(e){return 0<e.length}));r=e[r],Array.isArray(r)?o(i,n,r.slice(-1)[0],t):o(i,n,r,t)}))},r=arguments.length,i=new Array(1<r?r-1:0),a=1;a<r;a++)i[a-1]=arguments[a];return i.forEach((function(e){var n=e.added,r=e.removed;e=e.diff,null!=r&&t(r,!0),null!=n&&t(n),null!=e&&t(e)})),n}function l(e){var n={};return e.diff&&0<Object.keys(e.diff).length&&(n.diff=s(e.diff)),e.added&&0<Object.keys(e.added).length&&(n.added=s(e.added)),e.removed&&0<Object.keys(e.removed).length&&(n.removed=s(e.removed)),n}function u(e){var n={};return e.diff&&0<Object.keys(e.diff).length&&(n.diff=a(e.diff)),e.added&&0<Object.keys(e.added).length&&(n.added=a(e.added)),e.removed&&0<Object.keys(e.removed).length&&(n.removed=a(e.removed)),n}var d=function(){function e(){var n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:8;(function(n){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")})(this),this.precision=n,this.reset()}return r=[{key:"toObj",value:function(){var e=this,n={};Object.keys(this.references).forEach((function(t){n[t]={basedOn:e.references[t].basedOn,diff:l(e.references[t].diff)}}));var t=this.diffs.map((function(e){return[e[0],e[1],l(e[2]),e[3]]}));return{baseReference:f(this.baseReference),diffs:t,references:n,precision:this.precision,lastReferenceName:this.lastReferenceName}}},{key:"setFromObj",value:function(e){var n={};Object.keys(e.references).forEach((function(t){n[t]={basedOn:e.references[t].basedOn,diff:u(e.references[t].diff)}})),this.references=n,this.baseReference=f(e.baseReference),this.precision=e.precision,this.diffs=e.diffs.map((function(e){return[e[0],e[1],u(e[2]),e[3]]})),this.lastReferenceName=e.lastReferenceName}},{key:"reset",value:function(){this.baseReference=null,this.references={},this.diffs=[],this.lastReferenceName="__base"}},{key:"setBaseReference",value:function(e){this.baseReference=f(e),this.lastReferenceName="__base"}},{key:"addReference",value:function(e,n){var t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"__base";null!=this.baseReference&&"__base"!==n||this.setBaseReference(e),"__base"!==n&&(this.references[n]={diff:this.getDiffToReference(e,t),basedOn:t},this.lastReferenceName=n)}},{key:"getReferenceChain",value:function(e,t){return"__base"===e||null==this.references[e]?t:this.getReferenceChain(this.references[e].basedOn,[this.references[e].diff].concat(n(t)))}},{key:"getReference",value:function(e){return e=this.getReferenceChain(e,[]),c.apply(void 0,[this.baseReference].concat(n(e)))}},{key:"getDiffToReference",value:function(e,t){return t=this.getReferenceChain(t,[]),function(e,t,r,i,f){i=3<arguments.length&&void 0!==i?i:null;var o=4<arguments.length&&void 0!==f&&f,s=(f=e,a(f=0<t.length?c.apply(void 0,[e].concat(n(t))):f,"",{},i)),l=a(r,"",{},i),u={},d={},h={};return Object.keys(s).forEach((function(e){void 0!==l[e]?s[e]!==l[e]&&(d[e]=o?[s[e],l[e]]:l[e]):h[e]=s[e]})),Object.keys(l).forEach((function(e){void 0===s[e]&&(u[e]=l[e])})),i={},0<Object.keys(d).length&&(i.diff=d),0<Object.keys(u).length&&(i.added=u),0<Object.keys(h).length&&(i.removed=h),i}(this.baseReference,t,e,this.precision)}},{key:"getObjFromDiffAndReference",value:function(e,t){return t=this.getReferenceChain(t,[]),e=[].concat(n(t),[e]),c.apply(void 0,[this.baseReference].concat(n(e)))}},{key:"add",value:function(e,n){var t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:this.lastReferenceName,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0;null==this.baseReference&&this.setBaseReference(n),n=this.getDiffToReference(n,t),this.diffs.push([e,t,n,r])}},{key:"addWithWorker",value:function(e,n){var t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:this.lastReferenceName,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0;null==this.baseReference&&this.setBaseReference(n),this.startWorker(),null!=this.worker&&this.worker.postMessage([e,t,n,r])}},{key:"startWorker",value:function(){null==this.worker&&(this.worker=new Worker)}},{key:"getFromIndex",value:function(e){if(e>this.diffs.length||0===this.diffs.length)return null;r=3,e=(r=function(e){if(Array.isArray(e))return e}(n=this.diffs[e])||function(e,n){var t=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var r,i,f=[],a=!0,o=!1;try{for(t=t.call(e);!(a=(r=t.next()).done)&&(f.push(r.value),!n||f.length!==n);a=!0);}catch(e){o=!0,i=e}finally{try{a||null==t.return||t.return()}finally{if(o)throw i}}return f}}(n,r)||t(n,r)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}())[1];var n,r=r[2];return this.getObjFromDiffAndReference(r,e)}}],function(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(e.prototype,r),e;var r}(),h=new d;addEventListener("message",(function(e){e=(n=e.data).message;var n=n.payload;"reset"===e?((h=new d).baseReference=n.baseReference,h.references=n.references):"get"===e?postMessage({message:"cache",payload:{baseReferece:h.baseReference,references:h.references,diffs:h.diffs}}):"add"===e?h.add(n.now,n.state,n.reference,n.lastRecordTimeCount):"addReference"===e&&h.addReference(n.state,n.refName,n.basedOn)}))})();